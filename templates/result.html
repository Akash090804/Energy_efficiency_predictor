<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prediction Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ request.url_for('static', path='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <header class="header">
    <img src="https://static.vecteezy.com/system/resources/thumbnails/029/916/446/small/green-energy-efficiency-logo-chart-concept-green-energy-background-vector.jpg"
         alt="Energy Efficiency Logo" class="logo">
    <h1>Energy Efficiency Predictor</h1>
  </header>

  <div class="output">
    <p><strong>Heating Load:</strong> {{ heating }} kWh/m²</p>
    <p><strong>Cooling Load:</strong> {{ cooling }} kWh/m²</p>

    <canvas id="predictionChart" width="400" height="300"></canvas>

    <div class="download-buttons">
      <button onclick="downloadCSV()">⬇ Download CSV</button>
      <button onclick="downloadPDF()">⬇ Download PDF</button>
    </div>
  </div>

  <a href="/" class="back-btn">← Back to Form</a>

  <script>
    // Convert string values to float for Chart.js
    const heating = parseFloat("{{ heating }}");
    const cooling = parseFloat("{{ cooling }}");

    const ctx = document.getElementById('predictionChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Heating Load', 'Cooling Load'],
        datasets: [{
          label: 'Predicted Load (kWh/m²)',
          data: [heating, cooling],
          backgroundColor: ['#007bff', '#28a745'],
          borderRadius: 5
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed.y.toFixed(2)} kWh/m²`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'kWh/m²' }
          }
        }
      }
    });

    function downloadCSV() {
      const rows = [
        ["X1", "X2", "X3", "X4", "X5", "X6", "X7", "X8", "Heating Load", "Cooling Load"],
        ["{{ X1 }}", "{{ X2 }}", "{{ X3 }}", "{{ X4 }}", "{{ X5 }}", "{{ X6 }}", "{{ X7 }}", "{{ X8 }}", "{{ heating }}", "{{ cooling }}"]
      ];
      let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "prediction_results.csv");
      document.body.appendChild(link);
      link.click();
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Energy Efficiency Prediction", 20, 20);
      doc.setFontSize(12);
      doc.text(`Heating Load: {{ heating }} kWh/m²`, 20, 40);
      doc.text(`Cooling Load: {{ cooling }} kWh/m²`, 20, 50);

      const inputs = [
        "X1: {{ X1 }}", "X2: {{ X2 }}", "X3: {{ X3 }}", "X4: {{ X4 }}",
        "X5: {{ X5 }}", "X6: {{ X6 }}", "X7: {{ X7 }}", "X8: {{ X8 }}"
      ];
      inputs.forEach((line, i) => {
        doc.text(line, 20, 65 + i * 8);
      });

      const canvas = document.getElementById('predictionChart');
      const chartImage = canvas.toDataURL("image/png", 1.0);
      doc.addImage(chartImage, 'PNG', 20, 150, 160, 60);

      doc.save("prediction_result.pdf");
    }
  </script>

</body>
</html>